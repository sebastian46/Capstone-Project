<!-- 
	For settings page. Settings are updated once the user presses Submit, assuming no error cases occur (such as no ID or min > max)
-->
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
	<title>Settings</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://unpkg.com/jeezy@1.12.0/lib/jeezy.min.js"></script>
	<script src="https://unpkg.com/d3-marcon@2.0.2/build/d3-marcon.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Tangerine">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
	<script src="http://code.jquery.com/jquery-3.3.1.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600" rel="stylesheet">
	<link href="css/index.css" rel="stylesheet" type="text/css">
</head>
<body>
	<!-- load heading of page -->
	<nav>
		<div>
			<img id="biglogo" src="iis.png">
			<i class="fa fa-bars"></i>
		</div>
		<ul>
			<img id="smalllogo" src="logo_.png">
			<li><a href="index.html">Home</a></li>
			<li><a href="#">Inputs <i class="fa fa-sort-desc"></i></a>
				<ul>
					<li><a href="input1.html" id="input1"></a></li>
					<li><a href="input2.html" id="input2"></a></li>
					<li><a href="input3.html" id="input3"></a></li>
					<li><a href="input4.html" id="input4"></a></li>
					<li><a href="input5.html" id="input5"></a></li>
					<li><a href="input6.html" id="input6"></a></li>
					<li><a href="input7.html" id="input7"></a></li>
					<li><a href="input8.html" id="input8"></a></li>
					<li><a href="input9.html" id="input9"></a></li>
					<li><a href="input10.html" id="input10"></a></li>
					<li><a href="input11.html" id="input11"></a></li>
					<li><a href="input12.html" id="input12"></a></li>
				</ul>
			</li>
			<li><a href="settings.html">Settings</a></li>
		</ul>
	</nav>
	<!-- JQuery for menu -->
	<script type="text/javascript">

		$("nav div").click(function() {
			$("ul").slideToggle();
			$("ul ul").css("display", "none");
		});

		$("ul li").click(function() {
			$("ul ul").toggle();
		});

		$(window).resize(function() {
			if($(window).width() > 768) {
				$("ul").removeAttr('style');
			}
		});

	</script>
	<!-- This is to get the names of the sensors-->
	<script>
		// opens getNames.php and runs query to return all sensor's names
	    var ajax = new XMLHttpRequest();
	    ajax.open("GET", "php/getNames.php", true);
	    ajax.send();
	    // We receive the data in JSON format. This is to parse the information 
	    ajax.onreadystatechange = function() {
	    	// if no error
	        if (this.readyState == 4 && this.status == 200) {
	            var data = JSON.parse(this.responseText);
	            for(var a = 0; a < data.length; a++){
	            	var count = a+1;
	            	// ID inputx (where x is 1-12) gets sent to header HTML
	            	document.getElementById('input'+count).innerHTML = data[a].name;
	            }
	        }
	    };
	</script>
	<!-- Settings form -->
	<p>
		• ID: This is a <b>required</b> field. It corresponds to a sensor. For example, sensor 1 (the first sensor under the input list) would have an ID of 1. The last sensor would have an ID of 12.
	</p>
	<br>
	<p>
		• Name, min, max, low alarm, high alarm, units, decimal places: These are not required. You can change one setting without changing any of the other fields. Any changes will immediately be reflected on the website.
	</p>
	<br>
	<p>
		• *ERROR message goes away after 3s* An error message will be displayed if the input given conflicts with previous (or new) inputs. Ex: min cannot be greater than max.
	</p>
	<br>
		<form>
			<p>
			    <label>Enter ID</label>
				<input type="number" min="1" max="12" name="t1" id="t1">
			</p>
			<p>
				<label>Enter name</label>
			    <input type="text" name="t2" id="t2">
			</p>
			<p>
		        <label>Enter min</label>
		        <input type="number" step="any" min="-9999999999.9999999999" max="9999999999.9999999999" name="t3" id="t3">
		    </p>
		    <p>
		        <label>Enter max</label>
		        <input type="number" step="any" min="-9999999999.9999999999" max="9999999999.9999999999" name="t4" id="t4">
	    	</p>
	    	<p>
		        <label>Enter low alarm</label>
		        <input type="number" step="any" min="-9999999999.9999999999" max="9999999999.9999999999" name="t5" id="t5">
	        </p>
	        <p>
		        <label>Enter high alarm</label>
		        <input type="number" step="any" min="-9999999999.9999999999" max="9999999999.9999999999" name="t8" id="t8">
	        </p>
	        <p>
		        <label>Enter units</label>
		        <input type="text" name="t6" id="t6">
	        </p>
	        <p>
		        <label>Enter decimal places</label>
		        <input input type="number" min="1" max="10" name="t7" id="t7">
	        </p>
	        <label></label>
		    <input type="button" name="submit" id="submit" value="Submit" >
		    <span id="error_message" class="text-danger"></span>  
	        <span id="success_message" class="text-success"></span> 
		</form>
	<!-- ajax request -->
	<script>  
		$(document).ready(function(){ 
			// for refreshing the page on error message
			function resetPage() {
				//$("form").trigger("reset");  
				setTimeout(function(){  
					location.reload(); 
				}, 3000); 
			}
			// on form submit, store values given by user 
			$('#submit').click(function(){  
				var t1 = $('#t1').val(); // ID
				var t2 = $('#t2').val(); // name 
				var t3 = $('#t3').val(); // min
				var t4 = $('#t4').val(); // max
				var t5 = $('#t5').val(); // low alarm
				var t6 = $('#t6').val(); // units
				var t7 = $('#t7').val(); // decimal places
				var t8 = $('#t8').val(); // high alarm
				// if ID is empty, display this
				if(t1 == '')  
				{  
					$('#error_message').html(" ID must be specified"); 
					resetPage();
				} 
				// get current settings for comparison
				var data_test;
				$.ajax({  
					'async': false,
					'global': false,
					'url':"php/getSettings.php",  
					'method':"GET",  
					'data': data_test,  
					success:function(data){  
						data_test = data;
					},
					'dataType': "json"
				}); 
				// store settings for later comparison
				var sensor_min = data_test[t1-1].min;
				var sensor_max = data_test[t1-1].max;
				var sensor_low_alarm = data_test[t1-1].Low_Alarm;
				var sensor_high_alarm = data_test[t1-1].High_Alarm;
				
				// if min > max, display this
				// check if min is empty
				if (t3) {
					// if max is not empty
					if(t4){
						if(Number(t3) > Number(t4)){
							$('#error_message').html(" Min must be greater than max"); 
							resetPage();
						}
					}
					// if max is empty
					else{
						if(Number(t3) > Number(sensor_max)){
							$('#error_message').html(" Min must be greater than max"); 
							resetPage();
						}
					}
				}
				// if low alarm is not empty
				if (t5){
					// if min is not empty
					if(t3){
						if(Number(t5) <= Number(t3)){
							$('#error_message').html(" Low alarm must be greater than min"); 
							resetPage();
						}
					// if min is empty
					}else{
						if(Number(t5) <= Number(sensor_min)){
							$('#error_message').html(" Low alarm must be greater than min"); 
							resetPage();
						}
					}
					// if max is not empty
					if(t4){
						if(Number(t5) >= Number(t4)){
							$('#error_message').html(" Low alarm must be less than max");
							resetPage(); 
						}
					// if max is empty
					}else{
						if(Number(t5) >= Number(sensor_max)){
							$('#error_message').html(" Low alarm must be less than max"); 
							resetPage();
						}
					}
					// if high alarm is not empty
					if(t8){
						if(Number(t5) >= Number(t8)){
							$('#error_message').html(" Low alarm must be less than high alarm");
							resetPage(); 
						}
					// if high alarm is empty
					}else{
						if(Number(t5) >= Number(sensor_high_alarm)){
							$('#error_message').html(" Low alarm must be less than high alarm"); 
							resetPage();
						}
					}
				}
				// high alarm must be LEQ to max
				// if high alarm is not empty
				if (t8){
					// if min is not empty
					if(t3){
						if(Number(t8) <= Number(t3)){
							$('#error_message').html(" High alarm must be greater than min"); 
							resetPage();
						}
					// if min is empty
					}else{
						if(Number(t8) <= Number(sensor_min)){
							$('#error_message').html(" High alarm must be greater than min"); 
							resetPage();
						}
					}
					// if max is not empty
					if(t4){
						if(Number(t8) >= Number(t4)){
							$('#error_message').html(" High alarm must be less than max"); 
							resetPage();
						}
					// if max is empty
					}else{
						if(Number(t8) >= Number(sensor_max)){
							$('#error_message').html(" High alarm must be less than max"); 
							resetPage();
						}
					}
					// if low alarm is not empty
					if(t5){
						if(Number(t5) >= Number(t8)){
							$('#error_message').html(" Low alarm must be less than high alarm"); 
							resetPage();
						}
					// if high alarm is empty
					}else{
						if(Number(t8) >= Number(sensor_high_alarm)){
							$('#error_message').html(" Low alarm must be less than high alarm"); 
							resetPage();
						}
					}
				}
				// send ajax request and display success message if there are not error messages
				if($('#error_message').is(':empty')){
					$('#error_message').html('');  
					$.ajax({  
						url:"php/userInput.php",  
						method:"POST",  
						data:{t1:t1, t2:t2, t3:t3, t4:t4, t5:t5, t6:t6, t7:t7, t8:t8},  
						success:function(data){  
							$("form").trigger("reset");  
							$('#success_message').fadeIn().html(data);  
							setTimeout(function(){  
								$('#success_message').fadeOut("Slow"); 
								location.reload(); 
							}, 750);  
						}  
					});  
				}
			});  
		});  
	</script>  
</body>
</html>